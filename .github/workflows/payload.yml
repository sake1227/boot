name: payload提取

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'ROM 下载直链'
        required: true
        default: ''
      rom_name:
        description: '保存名称'
        required: true
        default: ''

jobs:
  payload:
    runs-on: ubuntu-24.04
    steps:
      - name: 检出代码
        uses: actions/checkout@main

      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get -y install python3-pip aria2 p7zip curl
          curl https://rclone.org/install.sh | sudo bash

      - name: 测试 Alist S3 接口
        run: |
          curl -v "http://154.89.148.233:5244/s3" \
            -H "Authorization: AWS ${{ secrets.ALIST_S3_ACCESS_KEY }}:${{ secrets.ALIST_S3_SECRET_KEY }}"

      - name: 配置 rclone (Alist S3)
        run: |
          # 创建 S3 类型的 remote，使用 GitHub Secrets 存储凭证
          rclone config create alist-s3 s3 \
            provider Other \
            access_key_id ${{ secrets.ALIST_S3_ACCESS_KEY }} \
            secret_access_key ${{ secrets.ALIST_S3_SECRET_KEY }} \
            endpoint http://154.89.148.233:5244/s3 \
            acl private

      - name: 下载并提取固件
        run: |
          echo "输入名称：${{ github.event.inputs.rom_name }}"
          mkdir -p "${GITHUB_WORKSPACE}/workspace" && cd "${GITHUB_WORKSPACE}/workspace"
          aria2c -s 12 -x 12 -d . -o firmware.zip "${{ github.event.inputs.rom_url }}"
          pip install --user git+https://github.com/sake1227/payload-dumper
          payload_dumper --partitions boot,vbmeta,init_boot firmware.zip

      - name: 压缩并上传文件
        run: |
          cd "${GITHUB_WORKSPACE}/workspace/output"
          7z a "${{ github.event.inputs.rom_name }}.zip" -p"${{ secrets.UNZIP_PASSWORD }}" *
          7z a "${{ github.event.inputs.rom_name }}.zip" /home/runner/work/boot/boot/获取解压密码.txt
          # 使用 S3 remote 上传到 Alist 的 zanfang 路径（bucket 名称为 zanfang）
          rclone copy "${{ github.event.inputs.rom_name }}.zip" alist-s3:zanfang/ \
            --transfers 8 \
            --multi-thread-streams 4 \
            --checksum \
            -P
